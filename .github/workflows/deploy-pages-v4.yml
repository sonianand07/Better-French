name: Auto Update French News â€“ v4

on:
  schedule:
    - cron:  '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      BF_PER_RUN_CAP: 10
      BF_DAILY_CAP: 9999
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      AI_ENGINE_HIGH_MODEL: openai/gpt-4o-mini

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -e ./ai_engine_v3
          pip install -e ./ai_engine_v4

      - name: Run fast v3 pipeline
        run: |
          python -m ai_engine_v3.scripts.fetch_news
          python -m ai_engine_v3.scripts.qualify_news

      - name: Reset v4 pending store
        run: rm -f ai_engine_v4/data/live/pending_articles.json

      - name: Copy data into v4 store
        run: |
          rsync -a ai_engine_v3/data/ ai_engine_v4/data/
          rsync -a ai_engine_v3/website/ ai_engine_v4/website/

      - name: Trim pending to today only
        run: |
          python - <<'PY'
          import json, datetime, pathlib
          pending_path = pathlib.Path('ai_engine_v4/data/live/pending_articles.json')
          if pending_path.exists():
              today = datetime.datetime.utcnow().date().isoformat()
              data = json.loads(pending_path.read_text('utf-8'))
              articles = data.get('articles', data)
              filtered = [a for a in articles if (a.get('processed_at','')[:10]==today)]
              pending_path.write_text(json.dumps({'articles':filtered},ensure_ascii=False,indent=2))
          PY

      - name: Cap pending to newest 10
        run: |
          python - <<'PY'
          import json, pathlib
          p = pathlib.Path('ai_engine_v4/data/live/pending_articles.json')
          if p.exists():
              data=json.loads(p.read_text('utf-8'))
              arts=data.get('articles', data)
              arts.sort(key=lambda a:a.get('processed_at',''), reverse=True)
              capped=arts[:10]
              p.write_text(json.dumps({'articles':capped}, ensure_ascii=False, indent=2))
          PY

      - name: Run high-tier verifier (v4)
        run: |
          PYTHONPATH="$GITHUB_WORKSPACE" python scripts/verify_news.py

      - name: Commit & push data changes
        run: |
          git config --global user.email "bot@betterfrench.io"
          git config --global user.name "BetterFrenchBot"
          git config --global core.hooksPath /dev/null
          git add ai_engine_v4/data ai_engine_v4/website || true
          if ! git diff --cached --quiet; then
            git commit -m "chore(v4): auto-update with verification" --no-verify
            git push
          fi

      # Deploy root site (replace)
      - name: Deploy root site ðŸš€
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./ai_engine_v4/website
          force_orphan: true
          commit_message: 'chore(deploy): update root site with v4 content'

      # Deploy preview under /v4-site/ (keep alongside root)
      - name: Deploy v4 preview ðŸš€
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./ai_engine_v4/website
          destination_dir: v4-site
          force_orphan: false
          commit_message: 'chore(deploy): update v4 preview site' 