name: V5 - Website Processor

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes - process new articles from Rony
  workflow_dispatch:       # Manual trigger for testing

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: v5-website-processor
  cancel-in-progress: false

jobs:
  process_website:
    runs-on: ubuntu-latest
    
    env:
      BF_PER_RUN_CAP: 15  # Increased from 10 to 15 as requested
      BF_DAILY_CAP: 9999
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      OPENROUTER_SCRAPER_API_KEY: ${{ secrets.OPENROUTER_SCRAPER_API_KEY }}
      AI_ENGINE_HIGH_MODEL: openai/gpt-4o-mini
      PYTHONPATH: ${{ github.workspace }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install aiohttp feedparser requests
          pip install -e ./ai_engine_v3
          pip install -e ./ai_engine_v4

      - name: ğŸ” Detect new articles from Rony
        run: |
          python3 - <<'EOF'
          import json
          import os
          from pathlib import Path
          from datetime import datetime
          
          print("ğŸ” V5 WEBSITE PROCESSOR - Detecting New Articles")
          print("=" * 50)
          
          # Check if Rony has collected articles
          data_file = Path('ai_engine_v5/data/scraper_data.json')
          if not data_file.exists():
              print("ğŸ“­ No data from Rony yet - scraper hasn't run")
              with open('process_needed.txt', 'w') as f:
                  f.write('false')
              exit(0)
          
          scraper_data = json.loads(data_file.read_text())
          
          if not scraper_data.get('scraper_runs'):
              print("ğŸ“­ No scraper runs found")
              with open('process_needed.txt', 'w') as f:
                  f.write('false')
              exit(0)
          
          # Find unprocessed runs (new articles)
          unprocessed_runs = []
          for run in scraper_data['scraper_runs']:
              if not run.get('processed_by_website', False):
                  unprocessed_runs.append(run)
          
          total_articles = sum(run['articles_selected'] for run in unprocessed_runs)
          
          print(f"ğŸ“Š Found {len(unprocessed_runs)} unprocessed runs")
          print(f"ğŸ“„ Total new articles: {total_articles}")
          
          # Show human-readable summary of what's available
          if len(unprocessed_runs) > 0:
              print("\nğŸ—ï¸  ARTICLE OVERVIEW FROM RONY:")
              print("=" * 50)
              
              for i, run in enumerate(unprocessed_runs[-3:], 1):  # Show latest 3 runs
                  timestamp = run.get('timestamp', 'Unknown time')
                  articles_count = run.get('articles_selected', 0)
                  avg_score = run.get('quality_metrics', {}).get('avg_v3_score', 0)
                  
                  print(f"\nğŸ“… Run #{i}: {timestamp}")
                  print(f"   ğŸ“Š Articles: {articles_count} selected (avg quality: {avg_score:.1f})")
                  
                  # Show sample article titles from this run
                  if 'selected_articles' in run and run['selected_articles']:
                      print("   ğŸ† Sample Articles:")
                      for j, article in enumerate(run['selected_articles'][:3], 1):
                          title = article.get('title', 'No title')[:60]
                          source = article.get('source', 'Unknown')
                          score = article.get('total_score', 0)
                          print(f"      {j}. \"{title}...\" ({source}, Score: {score:.1f})")
                      
                      if len(run['selected_articles']) > 3:
                          remaining = len(run['selected_articles']) - 3
                          print(f"      ... and {remaining} more articles")
          
          if len(unprocessed_runs) == 0:
              print("âœ… All articles are up to date")
              with open('process_needed.txt', 'w') as f:
                  f.write('false')
              exit(0)
          
          # Safety cap - process manageable batches for immediate feedback
          # Increase cap from 5 âœ 15 so a single run can publish a fuller page while
          # still preventing huge backlogs from slowing down the workflow.
          if total_articles > 15:
              print(f"\nâš ï¸ SAFETY CAP: {total_articles} articles found")
              print("   ğŸ›¡ï¸ Processing latest batch only (max 15 articles)")
              print("   ğŸ’¡ Small batches for immediate feedback and faster processing")
              # Take only enough runs to get ~5 articles
              selected_runs = []
              article_count = 0
              for run in reversed(unprocessed_runs):
                  selected_runs.insert(0, run)
                  article_count += run.get('articles_selected', 0)
                  if article_count >= 15:
                      break
              unprocessed_runs = selected_runs
              total_articles = sum(run['articles_selected'] for run in unprocessed_runs)
          
          print(f"\nğŸš€ PROCESSING QUEUE:")
          print(f"   ğŸ“Š Runs to process: {len(unprocessed_runs)}")
          print(f"   ğŸ“„ Total articles: {total_articles}")
          print("   ğŸ¯ Each article will get V3+V4 enhancement")
          
          # Save processing queue with human-readable article info
          articles_for_processing = []
          for run in unprocessed_runs:
              if 'selected_articles' in run:
                  articles_for_processing.extend(run['selected_articles'])
          
          # Show the actual articles that will be processed
          print(f"\nğŸ“‹ ARTICLES ENTERING V3+V4 PIPELINE:")
          print("=" * 50)
          for i, article in enumerate(articles_for_processing[:10], 1):
              title = article.get('title', 'No title')[:50]
              source = article.get('source', 'Unknown')[:15]
              score = article.get('total_score', 0)
              print(f"   {i:2}. \"{title}...\" ({source}, Score: {score:.1f})")
          
          if len(articles_for_processing) > 10:
              remaining = len(articles_for_processing) - 10
              print(f"   ... and {remaining} more articles")
          
          # Show IMMEDIATE article processing preview
          print(f"\nğŸš€ IMMEDIATE PROCESSING PREVIEW:")
          print("=" * 50)
          print(f"ğŸ“Š These {min(len(articles_for_processing), 5)} articles will be enhanced:")
          for i, article in enumerate(articles_for_processing[:5], 1):
              title = article.get('title', 'No title')[:60]
              source = article.get('source', 'Unknown')
              score = article.get('total_score', 0)
              print(f"   {i}. ğŸ”§ Processing: \"{title}...\"")
              print(f"      ğŸ“Š Source: {source} | Quality: {score:.1f}/25")
              print(f"      ğŸ¯ Will get: Contextual analysis â†’ Simplification â†’ GPT-4o verification")
              
          print(f"\nâš¡ Small batch processing: {len(articles_for_processing)} articles")
          print(f"ğŸ’° Estimated cost: ~${len(articles_for_processing) * 0.012:.3f}")
          print(f"â±ï¸ Estimated time: ~{len(articles_for_processing) * 30} seconds")
          print(f"ğŸ¯ Next: Starting AI enhancement pipeline...")
          
          with open('processing_queue.json', 'w') as f:
              json.dump({
                  'runs_to_process': unprocessed_runs,
                  'total_articles': total_articles,
                  'articles_for_processing': articles_for_processing
              }, f, indent=2)
          
          with open('process_needed.txt', 'w') as f:
              f.write('true')
          
          print(f"\nâœ… Ready to enhance {total_articles} articles with V3+V4 pipeline!")
          EOF

      - name: ğŸ¤– Apply V3+V4 Enhancement Pipeline
        run: |
          if [ "$(cat process_needed.txt)" = "true" ]; then
            echo "ğŸ¤– APPLYING V3+V4 ENHANCEMENT TO RONY'S ARTICLES"
            echo "=" * 50
            
            python3 - <<'EOF'
          import json
          import sys
          import os
          from pathlib import Path
          from datetime import datetime
          
          # Load processing queue
          with open('processing_queue.json', 'r') as f:
              queue = json.load(f)
          
          runs_to_process = queue['runs_to_process']
          articles_for_processing = queue['articles_for_processing']
          
          print(f"ğŸ¯ ENHANCEMENT PIPELINE STARTING")
          print(f"   ğŸ“Š Runs: {len(runs_to_process)}")
          print(f"   ğŸ“„ Articles: {len(articles_for_processing)}")
          print(f"   ğŸ”§ Method: PROVEN V3+V4 prompts (no quality reduction)")
          print("")
          
          # Show what will be enhanced
          print("ğŸ”§ ARTICLES ENTERING ENHANCEMENT:")
          for i, article in enumerate(articles_for_processing[:5], 1):
              title = article.get('title', 'No title')[:55]
              source = article.get('source', 'Unknown')
              score = article.get('total_score', 0)
              print(f"   {i}. \"{title}...\"")
              print(f"      ğŸ“Š Source: {source} | Quality: {score:.1f}/25")
          
          if len(articles_for_processing) > 5:
              remaining = len(articles_for_processing) - 5
              print(f"   ... and {remaining} more articles")
          
          print("")
          
          # Apply REAL V3+V4 enhancement pipeline
          try:
              print("ğŸ” Loading V5 WebsiteProcessor...")
              sys.path.append('ai_engine_v5')
              from core.processor.website_processor import WebsiteProcessor
              
              print("âœ… V5 WebsiteProcessor loaded successfully")
              print("ğŸ¯ Initializing with PROVEN V3+V4 components...")
              
              # Use V5's REAL processor (preserves V3+V4 quality)
              processor = WebsiteProcessor()
              
              print(f"\nğŸš€ STARTING ENHANCEMENT OF {len(articles_for_processing)} ARTICLES")
              print("=" * 60)
              print("ğŸ“‹ Pipeline Steps:")
              print("   1ï¸âƒ£ Convert to V3 format")
              print("   2ï¸âƒ£ Apply V3 contextual analysis (contextual_words_v3.jinja)")  
              print("   3ï¸âƒ£ Apply V3 simplification (simplify_titles_summaries_v3.jinja)")
              print("   4ï¸âƒ£ Apply V4 GPT-4o verification (review_tooltips.jinja)")
              print("   5ï¸âƒ£ Generate beautiful website")
              print("")
              
              enhanced_articles, enhancement_cost = processor.enhance_articles(articles_for_processing)
              
              print(f"\nâœ… ENHANCEMENT COMPLETE!")
              print(f"   ğŸ“Š Articles enhanced: {len(enhanced_articles)}")
              print(f"   ğŸ’° Total cost: ${enhancement_cost:.4f}")
              
              # Generate website with V3+V4 enhanced articles
              print(f"\nğŸŒ GENERATING WEBSITE...")
              website_result = processor.generate_website(enhanced_articles)
              
              print(f"âœ… WEBSITE GENERATED!")
              print(f"   ğŸ“ Files created: {website_result.get('files_created', 'Unknown')}")
              print(f"   ğŸ¨ Theme: Modern French learning interface")
              print(f"   ğŸ“± Features: Tooltips, responsive design, quality indicators")
              
          except Exception as e:
              print(f"âŒ ENHANCEMENT FAILED: {e}")
              print("ğŸš¨ NO FALLBACK MODE - FAILING PROPERLY!")
              print("ğŸ’¡ Fix the V5 WebsiteProcessor to resolve this issue")
              print("âŒ Workflow will fail to prevent fake website generation")
              
              # Don't create fallback - let it fail properly
              raise Exception(f"V5 enhancement failed: {e}")
          
          # Mark runs as processed
          data_file = Path('ai_engine_v5/data/scraper_data.json')
          scraper_data = json.loads(data_file.read_text())
          
          processed_timestamps = {run['timestamp'] for run in runs_to_process}
          processed_count = 0
          for run in scraper_data['scraper_runs']:
              if run['timestamp'] in processed_timestamps:
                  run['processed_by_website'] = True
                  processed_count += 1
          
          data_file.write_text(json.dumps(scraper_data, indent=2, ensure_ascii=False))
          
          print(f"\nâœ… PROCESSING COMPLETE!")
          print(f"   âœ… {processed_count} runs marked as processed")
          print(f"   ğŸŒ Website ready for deployment")
          print(f"   ğŸ“Š Articles enhanced and ready to view")
          EOF
          else
            echo "â„¹ï¸ No new articles to process"
          fi

      - name: ğŸš€ Deploy V5 Website
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./ai_engine_v5/website
          destination_dir: v5-site
          force_orphan: false
          keep_files: true
          commit_message: |
            ğŸŒ V5 website update - Rony's enhanced articles
            
            âœ… Profile-aware article selection by Rony
            ğŸ¤– V3+V4 enhancement pipeline applied
            ğŸ“Š Latest high-quality French learning content
            
      - name: âœ… Verify V5 Deployment
        run: |
          echo "ğŸ” Verifying V5 website deployment..."
          
          # Wait a moment for deployment to propagate
          sleep 10
          
          # Test if the website is accessible
          if curl -f -s "https://sonianand07.github.io/Better-French/v5-site/" > /dev/null; then
            echo "âœ… V5 website is live and accessible!"
          else
            echo "âš ï¸ V5 website might take a few minutes to propagate"
          fi
          
          echo "ğŸŒ V5 Website URL: https://sonianand07.github.io/Better-French/v5-site/"
          echo "ğŸ“Š Expected: Enhanced articles with French learning tooltips"

      - name: ğŸ“ Commit processing results
        run: |
          git config --global user.email "v5-processor@betterfrench.io"
          git config --global user.name "V5-WebsiteProcessor"
          git config --global core.hooksPath /dev/null
          
          git add ai_engine_v5/data/ || true
          
          if ! git diff --cached --quiet; then
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ğŸŒ V5 website processing: ${TIMESTAMP}
            
            âœ… Articles enhanced with V3+V4 pipeline
            ğŸ¯ Profile-aware content selection by Rony  
            ğŸ“Š High-quality French learning articles processed
            ğŸš€ Website deployed to /v5-site" --no-verify
            
            git push
            echo "âœ… Processing results committed successfully"
          else
            echo "â„¹ï¸ No processing data changes to commit"
          fi

      - name: ğŸ‰ Summary
        run: |
          echo "ğŸ‰ V5 WEBSITE PROCESSOR COMPLETE!"
          echo "=================================="
          echo ""
          echo "ğŸŒ Your V5 website is now live at:"
          echo "   https://sonianand07.github.io/Better-French/v5-site/"
          echo ""
          echo "ğŸ¤– Pipeline applied:"
          echo "   1ï¸âƒ£ Rony intelligent article selection"
          echo "   2ï¸âƒ£ V3 contextual analysis & simplification"
          echo "   3ï¸âƒ£ V4 GPT-4o verification"
          echo "   4ï¸âƒ£ V5 modern website generation"
          echo ""
          echo "âœ¨ Features:"
          echo "   ğŸ“± Responsive design"
          echo "   ğŸ¯ French learning tooltips"
          echo "   ğŸ“Š Quality indicators"
          echo "   ğŸ”„ Profile-aware content"
          echo ""
          echo "ğŸ”„ Next run: Manual trigger or scheduled"

      - name: Clean up
        run: |
          rm -f process_needed.txt processing_queue.json || true 