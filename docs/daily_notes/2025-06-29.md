# Daily Note: 2025-06-29

## Session Summary
Fixed critical issue where V3 website wasn't updating despite successful article processing.

## Accomplishments âœ…
1. **Identified V3 Deployment Issue**
   - V4 workflow was processing V3 articles but only deploying V4 site
   - Root site (V3) was never getting deployed
   
2. **Fixed V4 Workflow**
   - Added V3 deployment step to deploy-pages-v4.yml
   - Now deploys both V3 (root) and V4 (/v4-site/) when run
   - Used `keep_files: true` to preserve v4-site subdirectory

3. **CRITICAL FIX: V4 Article Processing + Data Preservation** 
   - âŒ **MAJOR ERROR #1**: First fix tried to process ALL 1,178 articles at once
   - âŒ **MAJOR ERROR #2**: Time filtering logic was broken, still processed 1,178 articles  
   - âŒ **MAJOR ERROR #3**: Copy step was destroying V4's enhanced articles from previous runs
   - ğŸš¨ **USER IMPACT**: Multiple workflow cancellations + loss of V4's accumulated work
   - âœ… **COMPREHENSIVE FIX**: 
     - Preserve V4's enhanced articles before copy step
     - Exclude rolling_articles.json from copy to protect V4's work
     - Process only last 15 articles from V3 (safety cap)
     - Merge preserved + newly enhanced articles 
     - Safety abort if >15 articles to process

## Pain Points ğŸ˜¤
1. **Confusing Workflow Dependencies**
   - V4 workflow runs V3's processing but wasn't deploying V3's site
   - This created a situation where articles were processed but not visible

## Next Actions ğŸš€
1. Run the updated V4 workflow to deploy both sites
2. Test current fix and verify both sites work correctly
3. **IMPLEMENT ARCHITECTURAL IMPROVEMENT** (User's proposal)

## ğŸ—ï¸ **FUTURE ARCHITECTURE PLAN** (User's Brilliant Idea)

**Current Problem:** 
- Monolithic workflow tries to scrape + process + deploy all at once
- Bulk processing issues when AI tries to handle 1,000+ articles
- Hard to debug and optimize individual components
- Resource inefficiency and unpredictable costs

**Proposed Solution - Workflow Separation:**

### 1. **Data Collection Workflow** (Hourly)
```yaml
name: Collect & Curate News Data
schedule: '0 * * * *'  # Every hour
```
**Responsibilities:**
- Scrape news sources (fetch_news.py)
- Apply rule-based filtering (CuratorV2)
- Score relevance with LLM (light usage)
- Build curated queue of ~10-20 articles per hour
- Store in `curated_queue.json`
- **NO AI processing** - just data collection & validation

### 2. **AI Processing Workflow** (On-demand/Scheduled)
```yaml
name: AI Process Curated Articles  
workflow_dispatch: true  # Manual trigger
# schedule: '0 */6 * * *'  # Every 6 hours (optional)
```
**Responsibilities:**
- Read from `curated_queue.json` 
- Process only pre-filtered articles (~60-120 articles max)
- Apply AI enhancements (V3 + V4 processing)
- Deploy both websites
- Clear processed articles from queue

**ğŸ¯ Benefits:**
- âœ… **No more bulk processing** - AI only sees pre-curated articles
- âœ… **Better resource management** - scraping runs light, AI runs heavy
- âœ… **Easier debugging** - can test scraping vs AI separately
- âœ… **Flexible scheduling** - collect hourly, process less frequently  
- âœ… **Cost control** - AI usage is predictable and bounded
- âœ… **Fault isolation** - scraping failures don't block AI processing
- âœ… **Better monitoring** - can track each component independently

**ğŸ”„ Proposed Data Flow:**
```
[News Sources] â†’ [Hourly Scraper] â†’ [curated_queue.json] â†’ [AI Processor] â†’ [V3 + V4 Sites]
```

**ğŸ“ Implementation Priority:** After testing current fixes

## File Change Log ğŸ“

| File | Type | Reason |
|------|------|--------|
| `.github/workflows/deploy-pages-v4.yml` | Modified | Fixed V4 scope issue - now processes only recent V3 articles |
| `config/config.ini` | Removed | Removed from git tracking to prevent API key exposure |
| `config/config.ini.template` | Created | Safe template file for development setup |
| `config/README.md` | Created | Comprehensive security documentation and guidelines |
| `scripts/check_api_exposure.py` | Created | Pre-commit hook to detect exposed API keys |
| `.githooks/pre-commit` | Modified | Enhanced with API key detection capabilities |

## Technical Details ğŸ”§
The issue occurred because:
- V3 workflow is disabled (schedule commented out)
- V4 workflow processes V3 articles but only deployed to /v4-site/
- Solution: V4 workflow now deploys to both locations

## SECURITY INCIDENT ğŸš¨

**API Key Exposure Discovered:**
- OpenRouter API key was exposed in `config/config.ini` 
- File was tracked in git and publicly visible
- OpenRouter auto-detected and disabled the key
- Workflow failing with 401 authentication errors

**Immediate Actions Taken:**
- âœ… Removed exposed key from config file
- âœ… Removed config.ini from git tracking
- âœ… Pushed security fix to GitHub

**Required Next Steps:**
1. Get new OpenRouter API key (old one is permanently disabled)
2. Store new key ONLY in GitHub Secrets (never commit to repo)
3. Test workflows with new key

## Task Tracker

| **Task** | **Status** | **Notes** |
|----------|------------|-----------|
| Identify V3 deployment issue | âœ… Done | V4 workflow missing V3 deploy |
| Fix V4 workflow | âœ… Done | Added V3 deployment step |
| Fix API key exposure | âœ… Done | Removed from git tracking |
| Get new API key | âœ… Done | Provided by user, stored in GitHub Secrets |
| Fix V4 article persistence | âœ… Done | Fixed scope issue - V4 processes only new articles |
| Test deployment | âŒ Pending | Ready to run with both fixes |
| Monitor both sites | âŒ Pending | Verify updates appear 